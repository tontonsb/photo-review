import{I as V,c as ie,d as $,e as fe,h as we,i as re,j as w,k as T,l as k,r as _e,m as Ee,E as K,u as xe,n as ye,S as Ie,o as ve,p as te,q as Se,s as W,v as C,w as Re,B as D,x as ae,y as Le,z as oe,L as be,C as Ce,A as se,D as ne,F as Ae,H as Me,J as Te,K as M,N as P,f as I,O as q,Q as ke,P as De,R as le,U as ce,b as O,V as U,G as Fe,M as F,T as ue,X as he,a as b,W as X,Y as Ge,g as H,Z as je,_ as Ne,$ as Y,a0 as We,a1 as Pe,t as ge}from"./XYZ-BScdlrqj.js";function B(u){return Array.isArray(u)?Math.min(...u):u}class Oe extends V{constructor(e,t,n,i,l,s,c){let r=e.getExtent();r&&e.canWrapX()&&(r=r.slice(),r[0]=-1/0,r[2]=1/0);let a=t.getExtent();a&&t.canWrapX()&&(a=a.slice(),a[0]=-1/0,a[2]=1/0);const o=a?ie(n,a):n,h=$(o),p=fe(e,t,h,i),g=ye,d=new we(e,t,o,r,p*g,i),f=d.calculateSourceExtent(),E=re(f)?null:s(f,p,l),_=E?w.IDLE:w.EMPTY,m=E?E.getPixelRatio():1;super(n,i,m,_),this.targetProj_=t,this.maxSourceExtent_=r,this.triangulation_=d,this.targetResolution_=i,this.targetExtent_=n,this.sourceImage_=E,this.sourcePixelRatio_=m,this.interpolate_=c,this.canvas_=null,this.sourceListenerKey_=null}disposeInternal(){this.state==w.LOADING&&this.unlistenSource_(),super.disposeInternal()}getImage(){return this.canvas_}getProjection(){return this.targetProj_}reproject_(){const e=this.sourceImage_.getState();if(e==w.LOADED){const t=T(this.targetExtent_)/this.targetResolution_,n=k(this.targetExtent_)/this.targetResolution_;this.canvas_=_e(t,n,this.sourcePixelRatio_,B(this.sourceImage_.getResolution()),this.maxSourceExtent_,this.targetResolution_,this.targetExtent_,this.triangulation_,[{extent:this.sourceImage_.getExtent(),image:this.sourceImage_.getImage()}],0,void 0,this.interpolate_,!0)}this.state=e,this.changed()}load(){if(this.state==w.IDLE){this.state=w.LOADING,this.changed();const e=this.sourceImage_.getState();e==w.LOADED||e==w.ERROR?this.reproject_():(this.sourceListenerKey_=Ee(this.sourceImage_,K.CHANGE,function(t){const n=this.sourceImage_.getState();(n==w.LOADED||n==w.ERROR)&&(this.unlistenSource_(),this.reproject_())},this),this.sourceImage_.load())}}unlistenSource_(){xe(this.sourceListenerKey_),this.sourceListenerKey_=null}}const A=4,j={IMAGELOADSTART:"imageloadstart",IMAGELOADEND:"imageloadend",IMAGELOADERROR:"imageloaderror"};class Ue extends D{constructor(e,t){super(e),this.image=t}}class He extends Ie{constructor(e){super({attributions:e.attributions,projection:e.projection,state:e.state,interpolate:e.interpolate!==void 0?e.interpolate:!0}),this.on,this.once,this.un,this.loader=e.loader||null,this.resolutions_=e.resolutions!==void 0?e.resolutions:null,this.reprojectedImage_=null,this.reprojectedRevision_=0,this.image=null,this.wantedExtent_,this.wantedResolution_,this.static_=e.loader?e.loader.length===0:!1,this.wantedProjection_=null}getResolutions(){return this.resolutions_}setResolutions(e){this.resolutions_=e}findNearestResolution(e){const t=this.getResolutions();if(t){const n=ve(t,e,0);e=t[n]}return e}getImage(e,t,n,i){const l=this.getProjection();if(!l||!i||te(l,i))return l&&(i=l),this.getImageInternal(e,t,n,i);if(this.reprojectedImage_){if(this.reprojectedRevision_==this.getRevision()&&te(this.reprojectedImage_.getProjection(),i)&&this.reprojectedImage_.getResolution()==t&&Se(this.reprojectedImage_.getExtent(),e))return this.reprojectedImage_;this.reprojectedImage_.dispose(),this.reprojectedImage_=null}return this.reprojectedImage_=new Oe(l,i,e,t,n,(s,c,r)=>this.getImageInternal(s,c,r,l),this.getInterpolate()),this.reprojectedRevision_=this.getRevision(),this.reprojectedImage_}getImageInternal(e,t,n,i){if(this.loader){const l=Ve(e,t,n,1),s=this.findNearestResolution(t);if(this.image&&(this.static_||this.wantedProjection_===i&&(this.wantedExtent_&&W(this.wantedExtent_,l)||W(this.image.getExtent(),l))&&(this.wantedResolution_&&B(this.wantedResolution_)===s||B(this.image.getResolution())===s)))return this.image;this.wantedProjection_=i,this.wantedExtent_=l,this.wantedResolution_=s,this.image=new V(l,s,n,this.loader),this.image.addEventListener(K.CHANGE,this.handleImageChange.bind(this))}return this.image}handleImageChange(e){const t=e.target;let n;switch(t.getState()){case w.LOADING:this.loading=!0,n=j.IMAGELOADSTART;break;case w.LOADED:this.loading=!1,n=j.IMAGELOADEND;break;case w.ERROR:this.loading=!1,n=j.IMAGELOADERROR;break;default:return}this.hasListener(n)&&this.dispatchEvent(new Ue(n,t))}}function Be(u,e){u.getImage().src=e}function Ve(u,e,t,n){const i=e/t,l=$(u),s=C(T(u)/i,A),c=C(k(u)/i,A),r=C((n-1)*s/2,A),a=s+2*r,o=C((n-1)*c/2,A),h=c+2*o;return Re(l,i,0,[a,h])}function $e(u){const e=u.load||ae,t=u.imageExtent,n=new Image;return u.crossOrigin!==null&&(n.crossOrigin=u.crossOrigin),()=>e(n,u.url).then(i=>{const l=T(t)/i.width,s=k(t)/i.height;return{image:i,extent:t,resolution:l!==s?[l,s]:s,pixelRatio:1}})}class z extends He{constructor(e){const t=e.crossOrigin!==void 0?e.crossOrigin:null,n=e.imageLoadFunction!==void 0?e.imageLoadFunction:Be;super({attributions:e.attributions,interpolate:e.interpolate,projection:Le(e.projection)}),this.url_=e.url,this.imageExtent_=e.imageExtent,this.image=null,this.image=new V(this.imageExtent_,void 0,1,$e({url:e.url,imageExtent:e.imageExtent,crossOrigin:t,load:(i,l)=>(this.image.setImage(i),n(this.image,l),ae(i))})),this.image.addEventListener(K.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(e,t,n,i){return oe(e,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}class Ke extends be{constructor(e){e=e||{},super(e)}}class qe extends Ce{constructor(e){super(e),this.image_=null}getImage(){return this.image_?this.image_.getImage():null}prepareFrame(e){const t=e.layerStatesArray[e.layerIndex],n=e.pixelRatio,i=e.viewState,l=i.resolution,s=this.getLayer().getSource(),c=e.viewHints;let r=e.extent;if(t.extent!==void 0&&(r=ie(r,se(t.extent,i.projection))),!c[ne.ANIMATING]&&!c[ne.INTERACTING]&&!re(r))if(s){const a=i.projection,o=s.getImage(r,l,n,a);o&&(this.loadImage(o)?this.image_=o:o.getState()===w.EMPTY&&(this.image_=null))}else this.image_=null;return!!this.image_}getData(e){const t=this.frameState;if(!t)return null;const n=this.getLayer(),i=Ae(t.pixelToCoordinateTransform,e.slice()),l=n.getExtent();if(l&&!Me(l,i))return null;const s=this.image_.getExtent(),c=this.image_.getImage(),r=T(s),a=Math.floor(c.width*((i[0]-s[0])/r));if(a<0||a>=c.width)return null;const o=k(s),h=Math.floor(c.height*((s[3]-i[1])/o));return h<0||h>=c.height?null:this.getImageData(c,a,h)}renderFrame(e,t){const n=this.image_,i=n.getExtent(),l=n.getResolution(),[s,c]=Array.isArray(l)?l:[l,l],r=n.getPixelRatio(),a=e.layerStatesArray[e.layerIndex],o=e.pixelRatio,h=e.viewState,p=h.center,g=h.resolution,d=o*s/(g*r),f=o*c/(g*r);this.prepareContainer(e,t);const E=this.context.canvas.width,_=this.context.canvas.height,m=this.getRenderContext(e);let x=!1,S=!0;if(a.extent){const R=se(a.extent,h.projection);S=oe(R,e.extent),x=S&&!W(R,e.extent),x&&this.clipUnrotated(m,e,R)}const y=n.getImage(),v=Te(this.tempTransform,E/2,_/2,d,f,0,r*(i[0]-p[0])/s,r*(p[1]-i[3])/c);this.renderedResolution=c*o/r;const Q=y.width*v[0],ee=y.height*v[3];if(this.getLayer().getSource().getInterpolate()||(m.imageSmoothingEnabled=!1),this.preRender(m,e),S&&Q>=.5&&ee>=.5){const R=v[4],pe=v[5],G=a.opacity;G!==1&&(m.save(),m.globalAlpha=G),m.drawImage(y,0,0,+y.width,+y.height,R,pe,Q,ee),G!==1&&m.restore()}return this.postRender(this.context,e),x&&m.restore(),m.imageSmoothingEnabled=!0,this.container}}class Z extends Ke{constructor(e){super(e)}createRenderer(){return new qe(this)}getData(e){return super.getData(e)}}function Xe(u,e,t,n,i,l){const s=[e.lon,e.lat],c=new M({geometry:new P(I(s))});return c.setStyle(new q({image:new ke({src:n,rotation:t})})),de(u,c,s,i,l)}function Ye(u,e,t,n){const i={north:parseFloat(e.north),east:parseFloat(e.east),south:parseFloat(e.south),west:parseFloat(e.west)},l=new M({geometry:new De([[I([i.west,i.north]),I([i.east,i.north]),I([i.east,i.south]),I([i.west,i.south]),I([i.west,i.north])]])});l.setStyle(new q({stroke:new le({color:"#b833ff",width:2}),fill:new ce({color:"#b833ff22"})}));const s=[(i.east+i.west)/2,(i.north+i.south)/2];return de(u,l,s,t,n)}function de(u,e,t,n,i){const l=new O({source:new U({format:new Fe,url:n})}),s=new F({target:u,layers:[new ue({source:new he({attributions:["Powered by Esri","Source: Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community"],url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",maxZoom:20})}),l,new O({source:new U({features:[e]})})],view:new b({center:I(t),zoom:14})});return s.on("click",function(c){const r=s.getEventPixel(c.originalEvent),a=[];s.forEachFeatureAtPixel(r,o=>{a.push({path:o.get("path"),url:o.get("url")})}),i(a)}),s.on("pointermove",function(c){if(c.dragging)return;s.getTargetElement().style.cursor="";const r=s.getEventPixel(c.originalEvent);s.forEachFeatureAtPixel(r,a=>{if(a.get("path")&&a.get("url"))return s.getTargetElement().style.cursor="pointer",!0})}),s}const et={pin:Xe,box:Ye},N="units",ze=[1,2,5],L=25.4/.28;class me extends X{constructor(e){e=e||{};const t=document.createElement("div");t.style.pointerEvents="none",super({element:t,render:e.render,target:e.target}),this.on,this.once,this.un;const n=e.className!==void 0?e.className:e.bar?"ol-scale-bar":"ol-scale-line";this.innerElement_=document.createElement("div"),this.innerElement_.className=n+"-inner",this.element.className=n+" "+Ge,this.element.appendChild(this.innerElement_),this.viewState_=null,this.minWidth_=e.minWidth!==void 0?e.minWidth:64,this.maxWidth_=e.maxWidth,this.renderedVisible_=!1,this.renderedWidth_=void 0,this.renderedHTML_="",this.addChangeListener(N,this.handleUnitsChanged_),this.setUnits(e.units||"metric"),this.scaleBar_=e.bar||!1,this.scaleBarSteps_=e.steps||4,this.scaleBarText_=e.text||!1,this.dpi_=e.dpi||void 0}getUnits(){return this.get(N)}handleUnitsChanged_(){this.updateElement_()}setUnits(e){this.set(N,e)}setDpi(e){this.dpi_=e}updateElement_(){const e=this.viewState_;if(!e){this.renderedVisible_&&(this.element.style.display="none",this.renderedVisible_=!1);return}const t=e.center,n=e.projection,i=this.getUnits(),l=i=="degrees"?"degrees":"m";let s=H(n,e.resolution,t,l);const c=this.minWidth_*(this.dpi_||L)/L,r=this.maxWidth_!==void 0?this.maxWidth_*(this.dpi_||L)/L:void 0;let a=c*s,o="";if(i=="degrees"){const x=je.degrees;a*=x,a<x/60?(o="窶ｳ",s*=3600):a<x?(o="窶ｲ",s*=60):o="ﾂｰ"}else if(i=="imperial")a<.9144?(o="in",s/=.0254):a<1609.344?(o="ft",s/=.3048):(o="mi",s/=1609.344);else if(i=="nautical")s/=1852,o="NM";else if(i=="metric")a<1e-6?(o="nm",s*=1e9):a<.001?(o="ﾎｼm",s*=1e6):a<1?(o="mm",s*=1e3):a<1e3?o="m":(o="km",s/=1e3);else if(i=="us")a<.9144?(o="in",s*=39.37):a<1609.344?(o="ft",s/=.30480061):(o="mi",s/=1609.3472);else throw new Error("Invalid units");let h=3*Math.floor(Math.log(c*s)/Math.log(10)),p,g,d,f,E,_;for(;;){d=Math.floor(h/3);const x=Math.pow(10,d);if(p=ze[(h%3+3)%3]*x,g=Math.round(p/s),isNaN(g)){this.element.style.display="none",this.renderedVisible_=!1;return}if(r!==void 0&&g>=r){p=f,g=E,d=_;break}else if(g>=c)break;f=p,E=g,_=d,++h}const m=this.scaleBar_?this.createScaleBar(g,p,o):p.toFixed(d<0?-d:0)+" "+o;this.renderedHTML_!=m&&(this.innerElement_.innerHTML=m,this.renderedHTML_=m),this.renderedWidth_!=g&&(this.innerElement_.style.width=g+"px",this.renderedWidth_=g),this.renderedVisible_||(this.element.style.display="",this.renderedVisible_=!0)}createScaleBar(e,t,n){const i=this.getScaleForResolution(),l=i<1?Math.round(1/i).toLocaleString()+" : 1":"1 : "+Math.round(i).toLocaleString(),s=this.scaleBarSteps_,c=e/s,r=[this.createMarker("absolute")];for(let o=0;o<s;++o){const h=o%2===0?"ol-scale-singlebar-odd":"ol-scale-singlebar-even";r.push(`<div><div class="ol-scale-singlebar ${h}" style="width: ${c}px;"></div>`+this.createMarker("relative")+(o%2===0||s===2?this.createStepText(o,e,!1,t,n):"")+"</div>")}return r.push(this.createStepText(s,e,!0,t,n)),(this.scaleBarText_?`<div class="ol-scale-text" style="width: ${e}px;">`+l+"</div>":"")+r.join("")}createMarker(e){return`<div class="ol-scale-step-marker" style="position: ${e}; top: ${e==="absolute"?3:-10}px;"></div>`}createStepText(e,t,n,i,l){const c=(e===0?0:Math.round(i/this.scaleBarSteps_*e*100)/100)+(e===0?"":" "+l),r=e===0?-3:t/this.scaleBarSteps_*-1,a=e===0?0:t/this.scaleBarSteps_*2;return`<div class="ol-scale-step-text" style="margin-left: ${r}px;text-align: ${e===0?"left":"center"};min-width: ${a}px;left: ${n?t+"px":"unset"};">`+c+"</div>"}getScaleForResolution(){const e=H(this.viewState_.projection,this.viewState_.resolution,this.viewState_.center,"m"),t=this.dpi_||L,n=1e3/25.4;return e*n*t}render(e){const t=e.frameState;t?this.viewState_=t.viewState:this.viewState_=null,this.updateElement_()}}function Ze(u){const e=document.createElement("button");e.innerHTML=u["remove all markers"],e.style.width="unset",e.style.fontWeight="unset";const t=document.createElement("div");t.className="ol-unselectable ol-control",t.style.right=".5em",t.style.bottom=".5em",t.style.display="none",t.appendChild(e);const n=new X({element:t});return{button:e,element:t,control:n}}function J(u){const e=new U,t=Ze(u),n=new O({source:e,style:new q({image:new Ne({radius:15,fill:new ce({color:"#ff33e022"}),stroke:new le({color:"#ff33e0",width:2})})})}),i=async r=>{const a=await n.getFeatures(r.pixel);if(a.length){a.forEach(o=>e.removeFeature(o));return}e.addFeature(new M(new P(r.coordinate))),t.element.style.display="block"},l=async r=>await n.getFeatures(r.pixel),s=()=>e.getFeatures().map(r=>r.getGeometry().getCoordinates()),c=r=>r.forEach(a=>e.addFeature(new M(new P(a))));return t.button.addEventListener("click",()=>{e.clear(!0),t.element.style.display="none"}),{layer:n,removeClicked:i,getClickedFeatures:l,getMarkers:s,addMarkers:c,clearControl:t.control}}function tt(u,e,t,n,i=!0){e=[0,0,e[0],e[1]];const l=new We({code:"this-image",units:"pixels",extent:e}),s=J(n),c=new F({controls:Y().extend([...i?[s.clearControl]:[]]),layers:[new Z({source:new z({url:t,projection:l,imageExtent:e})}),s.layer],target:u,view:new b({projection:l,center:$(e),extent:e,showFullExtent:!0,zoom:1})});c.getView().fit(e);const r=async a=>{const o=await s.layer.getFeatures(a.pixel);c.getTargetElement().style.cursor=o.length?"pointer":""};return i?(c.on("click",s.removeClicked),c.on("pointermove",r),c.on("click",a=>setTimeout(o=>r(a),10))):c.on("click",async a=>{const o=await s.getClickedFeatures(a),h=[];o.forEach(g=>{h.push(g.getGeometry().getCoordinates())});const p=new D("gotcoords");p.payload="Koordinﾄ》as (pikseﾄｼos nevis ﾄｫstﾄ《):<br>"+h.map(g=>g[1]+","+g[0]).join("<br>"),c.dispatchEvent(p)}),{map:c,userMarkers:s}}function st(u,e,t,n,i=!0){const l=Pe([parseFloat(e.west),parseFloat(e.south),parseFloat(e.east),parseFloat(e.north)],"EPSG:4326","EPSG:3857"),s=J(n),c=new me({units:"metric",bar:!0,steps:4,text:!1,minWidth:140}),r=new F({controls:Y().extend([c,...i?[s.clearControl]:[]]),layers:[new ue({source:new he({attributions:["Powered by Esri","Source: Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community"],url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",maxZoom:20})}),new Z({source:new z({url:t,imageExtent:l})}),s.layer],target:u,view:new b});r.getView().fit(l);const a=async o=>{const h=await s.layer.getFeatures(o.pixel);r.getTargetElement().style.cursor=h.length?"pointer":""};return i?(r.on("click",s.removeClicked),r.on("pointermove",a),r.on("click",o=>setTimeout(h=>a(o),10))):r.on("click",async o=>{const h=await s.getClickedFeatures(o),p=[];h.forEach(d=>{p.push(ge(d.getGeometry().getCoordinates()))});const g=new D("gotcoords");g.payload="Koordinﾄ》as:<br>"+p.map(d=>d[1]+","+d[0]).join("<br>"),r.dispatchEvent(g)}),{map:r,userMarkers:s}}function Je(){const u=document.createElement("button"),e=document.createElement("div");e.className="ol-unselectable ol-control",e.style.right=".5em",e.style.top=".5em",e.appendChild(u);const t=new X({element:e});return{button:u,control:t}}function nt(u,e,t,n,i,l,s=!0,c=!1){e=I(e);const r=new b({center:e}),a=c?.83236:H(r.getProjection(),1,e);n=[e[0]-n[0]/2/a,e[1]-n[1]/2/a,e[0]+n[0]/2/a,e[1]+n[1]/2/a];const o=new b({extent:n,showFullExtent:!0}),h=J(l),p=new me({units:"metric",bar:!0,steps:4,text:!1,minWidth:160}),g=Je();let d=window.sessionStorage.getItem("view-type")==="extent"?r:o;g.button.innerHTML=window.sessionStorage.getItem("view-type")==="extent"?"沐ｲ":"沐ｳ";const f=new F({controls:Y().extend([p,g.control,...s?[h.clearControl]:[]]),layers:[new Z({source:new z({url:i,imageExtent:n})}),h.layer],target:u,view:d});d.fit(n),g.button.addEventListener("click",_=>{d===r?(g.button.innerHTML="沐ｳ",window.sessionStorage.setItem("view-type","extent"),d=o):(g.button.innerHTML="沐ｲ",window.sessionStorage.setItem("view-type","free"),d=r),f.setView(d),d.fit(n)});const E=async _=>{const m=await h.layer.getFeatures(_.pixel);f.getTargetElement().style.cursor=m.length?"pointer":""};return s?(f.on("click",h.removeClicked),f.on("pointermove",E),f.on("click",_=>setTimeout(m=>E(_),10))):f.on("click",async _=>{const m=await h.getClickedFeatures(_);if(!m.length)return;const x=[];m.forEach(y=>{const v=y.getGeometry().clone();v.rotate(-t*Math.PI/180,e),x.push(ge(v.getCoordinates()))});const S=new D("gotcoords");S.payload="Koordinﾄ》as:<br>"+x.map(y=>y[1]+","+y[0]).join("<br>"),f.dispatchEvent(S)}),{map:f,userMarkers:h}}export{st as a,nt as b,tt as d,et as m};
