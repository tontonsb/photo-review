import{ab as W,ac as Z,k as G,ad as ae,ae as re,af as J,ag as f,ah as T,ai as A,aj as oe,l as le,E as O,u as ce,ak as he,al as ue,am as ge,a3 as q,an as de,ao as j,ap as v,aq as me,ar as _e,as as Q,a2 as fe,at as ee,au as pe,av as we,aw as X,ax as Y,ay as Ee,az as xe,aA as Ie,aB as te,aC as ye,g as F,aD as Se,V as Re,b as ve,S as Le,aE as Me,e as Te,d as Ae,F as K,c as z,M as H,a as M,aF as be,aG as De,aH as se,T as Ce,X as ke,f as je}from"./XYZ-DW-6z1kv.js";function N(h){return Array.isArray(h)?Math.min(...h):h}class Fe extends W{constructor(e,t,i,n,a,s,o){let c=e.getExtent();c&&e.canWrapX()&&(c=c.slice(),c[0]=-1/0,c[2]=1/0);let r=t.getExtent();r&&t.canWrapX()&&(r=r.slice(),r[0]=-1/0,r[2]=1/0);const l=r?Z(i,r):i,u=G(l),d=ae(e,t,u,n),g=he,_=new re(e,t,l,c,d*g,n),p=_.calculateSourceExtent(),w=J(p)?null:s(p,d,a),x=w?f.IDLE:f.EMPTY,m=w?w.getPixelRatio():1;super(i,n,m,x),this.targetProj_=t,this.maxSourceExtent_=c,this.triangulation_=_,this.targetResolution_=n,this.targetExtent_=i,this.sourceImage_=w,this.sourcePixelRatio_=m,this.interpolate_=o,this.canvas_=null,this.sourceListenerKey_=null}disposeInternal(){this.state==f.LOADING&&this.unlistenSource_(),super.disposeInternal()}getImage(){return this.canvas_}getProjection(){return this.targetProj_}reproject_(){const e=this.sourceImage_.getState();if(e==f.LOADED){const t=T(this.targetExtent_)/this.targetResolution_,i=A(this.targetExtent_)/this.targetResolution_;this.canvas_=oe(t,i,this.sourcePixelRatio_,N(this.sourceImage_.getResolution()),this.maxSourceExtent_,this.targetResolution_,this.targetExtent_,this.triangulation_,[{extent:this.sourceImage_.getExtent(),image:this.sourceImage_.getImage()}],0,void 0,this.interpolate_,!0)}this.state=e,this.changed()}load(){if(this.state==f.IDLE){this.state=f.LOADING,this.changed();const e=this.sourceImage_.getState();e==f.LOADED||e==f.ERROR?this.reproject_():(this.sourceListenerKey_=le(this.sourceImage_,O.CHANGE,function(t){const i=this.sourceImage_.getState();(i==f.LOADED||i==f.ERROR)&&(this.unlistenSource_(),this.reproject_())},this),this.sourceImage_.load())}}unlistenSource_(){ce(this.sourceListenerKey_),this.sourceListenerKey_=null}}const L=4,C={IMAGELOADSTART:"imageloadstart",IMAGELOADEND:"imageloadend",IMAGELOADERROR:"imageloaderror"};class Ne extends _e{constructor(e,t){super(e),this.image=t}}class We extends ue{constructor(e){super({attributions:e.attributions,projection:e.projection,state:e.state,interpolate:e.interpolate!==void 0?e.interpolate:!0}),this.on,this.once,this.un,this.loader=e.loader||null,this.resolutions_=e.resolutions!==void 0?e.resolutions:null,this.reprojectedImage_=null,this.reprojectedRevision_=0,this.image=null,this.wantedExtent_,this.wantedResolution_,this.static_=e.loader?e.loader.length===0:!1,this.wantedProjection_=null}getResolutions(){return this.resolutions_}setResolutions(e){this.resolutions_=e}findNearestResolution(e){const t=this.getResolutions();if(t){const i=ge(t,e,0);e=t[i]}return e}getImage(e,t,i,n){const a=this.getProjection();if(!a||!n||q(a,n))return a&&(n=a),this.getImageInternal(e,t,i,n);if(this.reprojectedImage_){if(this.reprojectedRevision_==this.getRevision()&&q(this.reprojectedImage_.getProjection(),n)&&this.reprojectedImage_.getResolution()==t&&de(this.reprojectedImage_.getExtent(),e))return this.reprojectedImage_;this.reprojectedImage_.dispose(),this.reprojectedImage_=null}return this.reprojectedImage_=new Fe(a,n,e,t,i,(s,o,c)=>this.getImageInternal(s,o,c,a),this.getInterpolate()),this.reprojectedRevision_=this.getRevision(),this.reprojectedImage_}getImageInternal(e,t,i,n){if(this.loader){const a=Oe(e,t,i,1),s=this.findNearestResolution(t);if(this.image&&(this.static_||this.wantedProjection_===n&&(this.wantedExtent_&&j(this.wantedExtent_,a)||j(this.image.getExtent(),a))&&(this.wantedResolution_&&N(this.wantedResolution_)===s||N(this.image.getResolution())===s)))return this.image;this.wantedProjection_=n,this.wantedExtent_=a,this.wantedResolution_=s,this.image=new W(a,s,i,this.loader),this.image.addEventListener(O.CHANGE,this.handleImageChange.bind(this))}return this.image}handleImageChange(e){const t=e.target;let i;switch(t.getState()){case f.LOADING:this.loading=!0,i=C.IMAGELOADSTART;break;case f.LOADED:this.loading=!1,i=C.IMAGELOADEND;break;case f.ERROR:this.loading=!1,i=C.IMAGELOADERROR;break;default:return}this.hasListener(i)&&this.dispatchEvent(new Ne(i,t))}}function Ge(h,e){h.getImage().src=e}function Oe(h,e,t,i){const n=e/t,a=G(h),s=v(T(h)/n,L),o=v(A(h)/n,L),c=v((i-1)*s/2,L),r=s+2*c,l=v((i-1)*o/2,L),u=o+2*l;return me(a,n,0,[r,u])}function He(h){const e=h.load||Q,t=h.imageExtent,i=new Image;return h.crossOrigin!==null&&(i.crossOrigin=h.crossOrigin),()=>e(i,h.url).then(n=>{const a=T(t)/n.width,s=A(t)/n.height;return{image:n,extent:t,resolution:a!==s?[a,s]:s,pixelRatio:1}})}class P extends We{constructor(e){const t=e.crossOrigin!==void 0?e.crossOrigin:null,i=e.imageLoadFunction!==void 0?e.imageLoadFunction:Ge;super({attributions:e.attributions,interpolate:e.interpolate,projection:fe(e.projection)}),this.url_=e.url,this.imageExtent_=e.imageExtent,this.image=null,this.image=new W(this.imageExtent_,void 0,1,He({url:e.url,imageExtent:e.imageExtent,crossOrigin:t,load:(n,a)=>(this.image.setImage(n),i(this.image,a),Q(n))})),this.image.addEventListener(O.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(e,t,i,n){return ee(e,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}class Pe extends pe{constructor(e){e=e||{},super(e)}}class Ve extends we{constructor(e){super(e),this.image_=null}getImage(){return this.image_?this.image_.getImage():null}prepareFrame(e){const t=e.layerStatesArray[e.layerIndex],i=e.pixelRatio,n=e.viewState,a=n.resolution,s=this.getLayer().getSource(),o=e.viewHints;let c=e.extent;if(t.extent!==void 0&&(c=Z(c,X(t.extent,n.projection))),!o[Y.ANIMATING]&&!o[Y.INTERACTING]&&!J(c))if(s){const r=n.projection,l=s.getImage(c,a,i,r);l&&(this.loadImage(l)?this.image_=l:l.getState()===f.EMPTY&&(this.image_=null))}else this.image_=null;return!!this.image_}getData(e){const t=this.frameState;if(!t)return null;const i=this.getLayer(),n=Ee(t.pixelToCoordinateTransform,e.slice()),a=i.getExtent();if(a&&!xe(a,n))return null;const s=this.image_.getExtent(),o=this.image_.getImage(),c=T(s),r=Math.floor(o.width*((n[0]-s[0])/c));if(r<0||r>=o.width)return null;const l=A(s),u=Math.floor(o.height*((s[3]-n[1])/l));return u<0||u>=o.height?null:this.getImageData(o,r,u)}renderFrame(e,t){const i=this.image_,n=i.getExtent(),a=i.getResolution(),[s,o]=Array.isArray(a)?a:[a,a],c=i.getPixelRatio(),r=e.layerStatesArray[e.layerIndex],l=e.pixelRatio,u=e.viewState,d=u.center,g=u.resolution,_=l*s/(g*c),p=l*o/(g*c);this.prepareContainer(e,t);const w=this.context.canvas.width,x=this.context.canvas.height,m=this.getRenderContext(e);let E=!1,b=!0;if(r.extent){const y=X(r.extent,u.projection);b=ee(y,e.extent),E=b&&!j(y,e.extent),E&&this.clipUnrotated(m,e,y)}const I=i.getImage(),R=Ie(this.tempTransform,w/2,x/2,_,p,0,c*(n[0]-d[0])/s,c*(d[1]-n[3])/o);this.renderedResolution=o*l/c;const U=I.width*R[0],$=I.height*R[3];if(this.getLayer().getSource().getInterpolate()||(m.imageSmoothingEnabled=!1),this.preRender(m,e),b&&U>=.5&&$>=.5){const y=R[4],ne=R[5],D=r.opacity;D!==1&&(m.save(),m.globalAlpha=D),m.drawImage(I,0,0,+I.width,+I.height,y,ne,U,$),D!==1&&m.restore()}return this.postRender(this.context,e),E&&m.restore(),m.imageSmoothingEnabled=!0,this.container}}class V extends Pe{constructor(e){super(e)}createRenderer(){return new Ve(this)}getData(e){return super.getData(e)}}const k="units",Be=[1,2,5],S=25.4/.28;class ie extends te{constructor(e){e=e||{};const t=document.createElement("div");t.style.pointerEvents="none",super({element:t,render:e.render,target:e.target}),this.on,this.once,this.un;const i=e.className!==void 0?e.className:e.bar?"ol-scale-bar":"ol-scale-line";this.innerElement_=document.createElement("div"),this.innerElement_.className=i+"-inner",this.element.className=i+" "+ye,this.element.appendChild(this.innerElement_),this.viewState_=null,this.minWidth_=e.minWidth!==void 0?e.minWidth:64,this.maxWidth_=e.maxWidth,this.renderedVisible_=!1,this.renderedWidth_=void 0,this.renderedHTML_="",this.addChangeListener(k,this.handleUnitsChanged_),this.setUnits(e.units||"metric"),this.scaleBar_=e.bar||!1,this.scaleBarSteps_=e.steps||4,this.scaleBarText_=e.text||!1,this.dpi_=e.dpi||void 0}getUnits(){return this.get(k)}handleUnitsChanged_(){this.updateElement_()}setUnits(e){this.set(k,e)}setDpi(e){this.dpi_=e}updateElement_(){const e=this.viewState_;if(!e){this.renderedVisible_&&(this.element.style.display="none",this.renderedVisible_=!1);return}const t=e.center,i=e.projection,n=this.getUnits(),a=n=="degrees"?"degrees":"m";let s=F(i,e.resolution,t,a);const o=this.minWidth_*(this.dpi_||S)/S,c=this.maxWidth_!==void 0?this.maxWidth_*(this.dpi_||S)/S:void 0;let r=o*s,l="";if(n=="degrees"){const E=Se.degrees;r*=E,r<E/60?(l="″",s*=3600):r<E?(l="′",s*=60):l="°"}else if(n=="imperial")r<.9144?(l="in",s/=.0254):r<1609.344?(l="ft",s/=.3048):(l="mi",s/=1609.344);else if(n=="nautical")s/=1852,l="NM";else if(n=="metric")r<1e-6?(l="nm",s*=1e9):r<.001?(l="μm",s*=1e6):r<1?(l="mm",s*=1e3):r<1e3?l="m":(l="km",s/=1e3);else if(n=="us")r<.9144?(l="in",s*=39.37):r<1609.344?(l="ft",s/=.30480061):(l="mi",s/=1609.3472);else throw new Error("Invalid units");let u=3*Math.floor(Math.log(o*s)/Math.log(10)),d,g,_,p,w,x;for(;;){_=Math.floor(u/3);const E=Math.pow(10,_);if(d=Be[(u%3+3)%3]*E,g=Math.round(d/s),isNaN(g)){this.element.style.display="none",this.renderedVisible_=!1;return}if(c!==void 0&&g>=c){d=p,g=w,_=x;break}else if(g>=o)break;p=d,w=g,x=_,++u}const m=this.scaleBar_?this.createScaleBar(g,d,l):d.toFixed(_<0?-_:0)+" "+l;this.renderedHTML_!=m&&(this.innerElement_.innerHTML=m,this.renderedHTML_=m),this.renderedWidth_!=g&&(this.innerElement_.style.width=g+"px",this.renderedWidth_=g),this.renderedVisible_||(this.element.style.display="",this.renderedVisible_=!0)}createScaleBar(e,t,i){const n=this.getScaleForResolution(),a=n<1?Math.round(1/n).toLocaleString()+" : 1":"1 : "+Math.round(n).toLocaleString(),s=this.scaleBarSteps_,o=e/s,c=[this.createMarker("absolute")];for(let l=0;l<s;++l){const u=l%2===0?"ol-scale-singlebar-odd":"ol-scale-singlebar-even";c.push(`<div><div class="ol-scale-singlebar ${u}" style="width: ${o}px;"></div>`+this.createMarker("relative")+(l%2===0||s===2?this.createStepText(l,e,!1,t,i):"")+"</div>")}return c.push(this.createStepText(s,e,!0,t,i)),(this.scaleBarText_?`<div class="ol-scale-text" style="width: ${e}px;">`+a+"</div>":"")+c.join("")}createMarker(e){return`<div class="ol-scale-step-marker" style="position: ${e}; top: ${e==="absolute"?3:-10}px;"></div>`}createStepText(e,t,i,n,a){const o=(e===0?0:Math.round(n/this.scaleBarSteps_*e*100)/100)+(e===0?"":" "+a),c=e===0?-3:t/this.scaleBarSteps_*-1,r=e===0?0:t/this.scaleBarSteps_*2;return`<div class="ol-scale-step-text" style="margin-left: ${c}px;text-align: ${e===0?"left":"center"};min-width: ${r}px;left: ${i?t+"px":"unset"};">`+o+"</div>"}getScaleForResolution(){const e=F(this.viewState_.projection,this.viewState_.resolution,this.viewState_.center,"m"),t=this.dpi_||S,i=1e3/25.4;return e*i*t}render(e){const t=e.frameState;t?this.viewState_=t.viewState:this.viewState_=null,this.updateElement_()}}function B(){const h=new Re,e=new ve({source:h,style:new Le({image:new Me({radius:15,fill:new Te({color:"#ff33e022"}),stroke:new Ae({color:"#ff33e0",width:2})})})});return{layer:e,clickHandler:async a=>{const s=await e.getFeatures(a.pixel);if(s.length){s.forEach(o=>h.removeFeature(o));return}h.addFeature(new K(new z(a.coordinate)))},getMarkers:()=>h.getFeatures().map(a=>a.getGeometry().getCoordinates()),addMarkers:a=>a.forEach(s=>h.addFeature(new K(new z(s))))}}function qe(h,e,t,i=!0){e=[0,0,e[0],e[1]];const n=new be({code:"this-image",units:"pixels",extent:e}),a=B(),s=new H({layers:[new V({source:new P({url:t,projection:n,imageExtent:e})}),a.layer],target:h,view:new M({projection:n,center:G(e),extent:e,showFullExtent:!0,zoom:1})});s.getView().fit(e);const o=async c=>{const r=await a.layer.getFeatures(c.pixel);s.getTargetElement().style.cursor=r.length?"pointer":""};return i&&(s.on("click",a.clickHandler),s.on("pointermove",o),s.on("click",c=>setTimeout(r=>o(c),10))),{map:s,userMarkers:a}}function Xe(h,e,t,i=!0){const n=De([parseFloat(e.west),parseFloat(e.south),parseFloat(e.east),parseFloat(e.north)],"EPSG:4326","EPSG:3857"),a=B(),s=new ie({units:"metric",bar:!0,steps:4,text:!1,minWidth:140}),o=new H({controls:se().extend([s]),layers:[new Ce({source:new ke({attributions:["Powered by Esri","Source: Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community"],url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",maxZoom:20})}),new V({source:new P({url:t,imageExtent:n})}),a.layer],target:h,view:new M});o.getView().fit(n);const c=async r=>{const l=await a.layer.getFeatures(r.pixel);o.getTargetElement().style.cursor=l.length?"pointer":""};return i&&(o.on("click",a.clickHandler),o.on("pointermove",c),o.on("click",r=>setTimeout(l=>c(r),10))),{map:o,userMarkers:a}}function Ue(){const h=document.createElement("button"),e=document.createElement("div");e.className="ol-unselectable ol-control",e.style.right=".5em",e.style.top=".5em",e.appendChild(h);const t=new te({element:e});return{button:h,control:t}}function Ye(h,e,t,i,n=!0,a=!0){e=je(e);const s=new M({center:e}),o=a?F(s.getProjection(),1,e):1;t=[e[0]-t[0]/2/o,e[1]-t[1]/2/o,e[0]+t[0]/2/o,e[1]+t[1]/2/o];const c=new M({extent:t,showFullExtent:!0}),r=B(),l=new ie({units:"metric",bar:!0,steps:4,text:!1,minWidth:160}),u=Ue();let d=window.sessionStorage.getItem("view-type")==="extent"?c:s;u.button.innerHTML=window.sessionStorage.getItem("view-type")==="extent"?"🔳":"🔲";const g=new H({controls:se().extend([l,u.control]),layers:[new V({source:new P({url:i,imageExtent:t})}),r.layer],target:h,view:d});g.getView().fit(t),u.button.addEventListener("click",p=>{d===s?(u.button.innerHTML="🔳",window.sessionStorage.setItem("view-type","extent"),d=c):(u.button.innerHTML="🔲",window.sessionStorage.setItem("view-type","free"),d=s),g.setView(d),d.fit(t)});const _=async p=>{const w=await r.layer.getFeatures(p.pixel);g.getTargetElement().style.cursor=w.length?"pointer":""};return n&&(g.on("click",r.clickHandler),g.on("pointermove",_),g.on("click",p=>setTimeout(w=>_(p),10))),{map:g,userMarkers:r}}export{Xe as a,Ye as b,qe as d};
